/*!
 * @version 1.0.0
 * @author Barin Britva
 * @license The MIT License (MIT) Copyright (c) 2014
 * @link https://github.com/barinbritva/coordinates-picker
 */
(function(global,factory){if(typeof define==="function"&&define.amd){return define(["jquery","googlemaps"],factory);}else{return global["BarinBritva.CoordinatesPicker"]=factory(global.jQuery,global.google);}})(this,function($,google){if(typeof(BarinBritva)==="undefined"){BarinBritva={};}BarinBritva.CoordinatesPicker=function(options){this._construct(options);};BarinBritva.CoordinatesPicker.prototype={_addressFields:null,_mapContainer:null,_coordinateField:null,_coordinatesFormat:"lng lat",_defaultCoordinates:new google.maps.LatLng(59.95,30.317),_defaultZoom:4,_zoomLevels:{country:4,locality:10,route:15,street_address:17},_mapParams:{mapTypeId:google.maps.MapTypeId.ROADMAP},_markerParams:{draggable:true,animation:google.maps.Animation.DROP},_selectValue:false,_map:null,_geocoder:new google.maps.Geocoder(),_marker:null,_cache:{},_lastAddress:"",_getZoomLevel:function(type){var levels=this._zoomLevels;if(typeof levels[type]==="undefined"){var mapZoom=this._map.getZoom();return typeof mapZoom==="undefined"?this._defaultZoom:mapZoom;}else{return levels[type];}},_construct:function(params){this._setParams(params);delete (params);this._initMap();this._watchAddress();},_setParams:function(params){var necessary=["fields","container","coordinates"];for(var key in necessary){var option=params[necessary[key]];if(!(option instanceof jQuery)||option.size()==0){throw new Error('Parameter "'+necessary[key]+'" is empty or not jQuery object.');}}this._addressFields=params.fields;this._mapContainer=params.container;this._coordinateField=params.coordinates;if(typeof(params.format)!=="undefined"){if(typeof(params.format)==="string"){this._coordinatesFormat=params.format;}else{throw new Error('Parameter "format" must be string value.');}}if(typeof(params.selectValue)!=="undefined"){if(typeof(params.selectValue)==="boolean"){this._selectValue=params.selectValue;}else{throw new Error('Parameter "selectValue" must be boolean value.');}}if(typeof(params.center)!=="undefined"){if(params.center instanceof google.maps.LatLng){this._defaultCoordinates=params.center;}else{if(params.center instanceof Array){if(params.center.length!==2||isNaN(params.center[0])||isNaN(params.center[1])){throw new Error('Parameter "center" must have only two numbers.');}this._defaultCoordinates=new google.maps.LatLng(params.center[0],params.center[1]);}else{throw new Error('Parameter "center" is not google.maps.LatLng object or array.');}}}if(typeof(params.zooms)!=="undefined"){if(params.zooms instanceof Object){var zooms=params.zooms;if(typeof(zooms.initial)!=="undefined"&&!isNaN(zooms.initial)){this._defaultZoom=zooms.initial;}if(typeof(zooms.country)!=="undefined"&&!isNaN(zooms.country)){this._zoomLevels.country=zooms.country;}if(typeof(zooms.locality)!=="undefined"&&!isNaN(zooms.locality)){this._zoomLevels.locality=zooms.locality;}if(typeof(zooms.route)!=="undefined"&&!isNaN(zooms.route)){this._zoomLevels.route=zooms.route;}if(typeof(zooms.street_address)!=="undefined"&&!isNaN(zooms.street_address)){this._zoomLevels.street_address=zooms.street_address;}}else{throw new Error('Parameter "zooms" is not object.');}}if(typeof(params.marker)!=="undefined"&&(params.marker instanceof Object)){for(var key in params.marker){this._markerParams[key]=params.marker[key];}}if(typeof(params.map)!=="undefined"&&(params.map instanceof Object)){for(var key in params.map){this._mapParams[key]=params.map[key];}}},_initMap:function(){var params=this._mapParams;var map=new google.maps.Map(this._mapContainer[0],params);var self=this;google.maps.event.addListenerOnce(map,"idle",function(){self._initView();});this._map=map;},_initView:function(){var position=this._getPositionFromField();if(position instanceof google.maps.LatLng){this._initByCoordinates(position);}else{if(this._hasAddress()){this._initByAddress();}else{this._initByDefault();}}},_getPositionFromField:function(){var position=false;var format=this._coordinatesFormat;var delimiter=format.replace("lat","");delimiter=delimiter.replace("lng","");var coordinates=this._coordinateField.val().split(delimiter);if(coordinates.length==2&&!isNaN(coordinates[0])&&!isNaN(coordinates[1])){if(format.indexOf("lng")<format.indexOf("lat")){position=new google.maps.LatLng(coordinates[1],coordinates[0]);}else{position=new google.maps.LatLng(coordinates[0],coordinates[1]);}}return position;},_hasAddress:function(){return(this._getAddressFromFields()!="");},_getAddressFromFields:function(){var self=this,address="";this._addressFields.each(function(){var $this=$(this);if($this.val()!=""){var tagName=$this.prop("tagName").toLowerCase();if(tagName==="select"&&!self._selectValue){address+=$this.find("option:selected").text();}else{address+=$this.val();}address+=",";}});address=address.replace(/\,+$/,"");return address;},_initByCoordinates:function(position){var zoom=this._getZoomLevel("street_address");this._markPlace(position,zoom);},_markPlace:function(position,zoom){this._setView(position,zoom);this._putMarker(position);},_setView:function(position,zoom){this._map.setCenter(position);this._map.setZoom(zoom);this._burnEvent({type:"viewchange"});},_putMarker:function(position){var marker=this._marker;if(marker===null||!this._isEqualCoordinates(marker.getPosition(),position)){this._removeMarker();var params=this._markerParams;params.position=position;params.map=this._map;marker=new google.maps.Marker(params);this._marker=marker;this._setCoordinates(position);var self=this;google.maps.event.addListener(marker,"dragend",function(event){self._setCoordinates(event.latLng);});}},_isEqualCoordinates:function(position1,position2){return position1.lat()===position2.lat()&&position1.lng()===position2.lng();},_setCoordinates:function(position){var lat=position.lat(),lng=position.lng();this._coordinateField.val(this._formatCoordinates(position));this._burnCoordinatesChange();},_formatCoordinates:function(position,format){var coordinates="";format=format||this._coordinatesFormat;if(position!==null){coordinates=format.replace("lat",position.lat());coordinates=coordinates.replace("lng",position.lng());}return coordinates;},_burnCoordinatesChange:function(){var marker=this._marker;var data={type:"coordschange",marker:marker};data.position=this.getPosition();this._burnEvent(data);},_removeMarker:function(){if(this._marker!==null){this._marker.setMap(null);this._coordinateField.val("");}},_initByAddress:function(){var self=this;this._geocode(this._getAddressFromFields(),function(response){if(response.status==google.maps.GeocoderStatus.OK){self._markPlaceFromGeocoding(response);}else{this._initByDefault();}});},_markPlaceFromGeocoding:function(response){var position=response.results[0].geometry.location;var zoom=this._getZoomLevel(response.results[0].types[0]);this._markPlace(position,zoom);},_geocode:function(address,callback){this._lastAddress=address;var self=this;this._burnEvent({type:"geocodingstart",address:address});this._geocoder.geocode({address:address},function(results,status){self._burnEvent({type:"geocodingend",address:address,status:status,results:results});var response={status:status,results:results};self._cache[address]=response;callback(response);});},_initByDefault:function(){var position=this._defaultCoordinates;var zoom=this._defaultZoom;this._setView(position,zoom);},_watchAddress:function(){var self=this;var runGeocode=0;this._addressFields.on("change keyup",function(){var address=self._getAddressFromFields();if(address!==""&&address!==self._lastAddress){if(runGeocode>0){clearTimeout(runGeocode);}runGeocode=setTimeout(function(){if(self._isInCache(address)){self._markPlaceFromGeocoding(self._getCachedAddress(address));}else{self._geocode(address,function(response){if(response.status==google.maps.GeocoderStatus.OK){self._markPlaceFromGeocoding(response);}});}},500);}});},_isInCache:function(address){return this._cache.hasOwnProperty(address);},_getCachedAddress:function(address){return this._cache[address];},_burnEvent:function(data){var customEvent=jQuery.Event(data.type);delete (data.type);for(var index in data){customEvent[index]=data[index];}customEvent.map=this._map;customEvent.mapCenter=this._map.getCenter();customEvent.mapZoom=this._map.getZoom();this._mapContainer.trigger(customEvent);},getMap:function(){return this._map;},getMarker:function(){return this._marker;},getPosition:function(){var marker=this._marker;return marker===null?null:marker.getPosition();},getPoint:function(format){return this._formatCoordinates(this.getPosition(),format);}};return BarinBritva.CoordinatesPicker;});